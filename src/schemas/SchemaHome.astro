---
import { getCollection } from 'astro:content';
import googleReviewsData from '../data/google-reviews.json';

// Fetch FAQs for homepage schema (both general and homepage-specific)
const allFaqs = await getCollection('faq');

// Get FAQs to include in homepage schema
// Include: showOnHomepage FAQs + first 5 general FAQs
const homepageFaqs = allFaqs.filter((faq) => faq.data.showOnHomepage === true).sort((a, b) => a.data.order - b.data.order);

const generalFaqs = allFaqs
    .filter((faq) => faq.data.category === 'general' && !faq.data.showOnHomepage)
    .sort((a, b) => a.data.order - b.data.order)
    .slice(0, 5);

// Combine for schema - only include FAQs that have a proper answer text
const schemaFaqs = [...generalFaqs, ...homepageFaqs].filter((faq) => faq.data.shortAnswer || faq.data.teaser || faq.data.description);

// Generate FAQ schema data
const faqSchemaData = {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    mainEntity: schemaFaqs.map((faq) => ({
        '@type': 'Question',
        name: faq.data.title,
        acceptedAnswer: {
            '@type': 'Answer',
            text: faq.data.shortAnswer || faq.data.teaser || faq.data.description
        }
    }))
};

// Generate reviews for schema - 5 latest reviews with text (matches homepage display)
const schemaReviews = googleReviewsData.reviews
    .filter((review) => review.quote && review.quote.trim().length > 0)
    .slice(0, 5)
    .map((review) => ({
        '@type': 'Review',
        author: { '@type': 'Person', name: review.author },
        reviewBody: review.quote.length > 300 ? review.quote.substring(0, 300) + '...' : review.quote,
        reviewRating: { '@type': 'Rating', ratingValue: String(review.starRating), bestRating: '5' },
        datePublished: review.createTime ? review.createTime.split('T')[0] : undefined
    }));

// Generate MedicalBusiness schema
const medicalBusinessSchema = {
    '@context': 'https://schema.org',
    '@type': 'MedicalBusiness',
    name: 'Hypnosetherapie Bern – Janine Aerni',
    image: {
        '@type': 'ImageObject',
        url: 'https://bern-hypnose.ch/janine-aerni-hypnose-bern-600w.jpg',
        width: 600,
        height: 600,
        caption: 'Janine Aerni – Diplomierte Hypnosetherapeutin in Bern'
    },
    logo: 'https://bern-hypnose.ch/janine-aerni-hypnose-bern-600w.jpg',
    description:
        'Hypnosetherapie Bern – Janine Aerni. Professionelle Hypnosetherapie in Bern, um Stress, Ängste, Phobien und mehr zu überwinden. Erfahre, wie Hypnose dir helfen kann, ein gesünderes und ausgeglicheneres Leben zu führen.',
    address: {
        '@type': 'PostalAddress',
        streetAddress: 'Eigerstrasse 56',
        addressLocality: 'Bern',
        postalCode: '3007',
        addressCountry: 'CH'
    },
    geo: {
        '@type': 'GeoCoordinates',
        latitude: '46.9400119148607',
        longitude: '7.436508173013693'
    },
    telephone: '+41 79 833 03 85',
    contactPoint: {
        '@type': 'ContactPoint',
        contactType: 'Customer Service',
        telephone: '+41 79 833 03 85',
        email: 'janine@bern-hypnose.ch'
    },
    url: 'https://bern-hypnose.ch',
    priceRange: '120 CHF - 150 CHF',
    openingHours: 'Mo,Tu,We,Th,Fr 07:00-19:00',
    sameAs: [
        'https://www.facebook.com/profile.php?id=61564940341284',
        'https://www.linkedin.com/in/janine-aerni-b7452a321/',
        'https://www.instagram.com/janineaerni/'
    ],
    founder: {
        '@type': 'Person',
        name: 'Janine Aerni',
        jobTitle: 'Diplomierte Hypnosetherapeutin',
        telephone: '+41 79 833 03 85',
        email: 'janine@bern-hypnose.ch',
        knowsAbout: [
            'Hypnose',
            'Hypnosetherapie',
            'Rauchstopp mit Hypnose',
            'Hypnose für Ängste',
            'Hypnose für Selbstvertrauen',
            'Hypnose bei Stress',
            'Hypnose bei Burnout',
            'Hypnose bei Depression'
        ]
    },
    areaServed: [
        { '@type': 'Place', name: 'Bern' },
        { '@type': 'Place', name: 'Köniz' },
        { '@type': 'Place', name: 'Wabern' },
        { '@type': 'Place', name: 'Liebefeld' },
        { '@type': 'Place', name: 'Muri bei Bern' },
        { '@type': 'Place', name: 'Ostermundigen' },
        { '@type': 'Place', name: 'Ittigen' },
        { '@type': 'Place', name: 'Bremgarten bei Bern' },
        { '@type': 'Place', name: 'Kirchlindach' },
        { '@type': 'Place', name: 'Wohlen bei Bern' }
    ],
    aggregateRating: {
        '@type': 'AggregateRating',
        ratingValue: String(googleReviewsData.overallRating),
        bestRating: '5',
        ratingCount: String(googleReviewsData.totalReviewCount)
    },
    review: schemaReviews,
    hasMap: 'https://maps.app.goo.gl/6ztgohYSpsWiT9CB8',
    paymentAccepted: 'Bargeld, TWINT, auf Rechnung',
    hasOfferCatalog: {
        '@type': 'OfferCatalog',
        name: 'Hypnosetherapie Dienstleistungen in Bern',
        itemListElement: [
            {
                '@type': 'Offer',
                itemOffered: {
                    '@type': 'Service',
                    name: 'Hypnosetherapie gegen Ängste und Phobien',
                    description: 'Professionelle Hypnosetherapie zur Überwindung von Ängsten, Phobien und Angststörungen in Bern'
                }
            },
            {
                '@type': 'Offer',
                itemOffered: {
                    '@type': 'Service',
                    name: 'Rauchstopp mit Hypnose',
                    description: 'Rauchentwöhnung durch Hypnosetherapie in Bern'
                }
            },
            {
                '@type': 'Offer',
                itemOffered: {
                    '@type': 'Service',
                    name: 'Hypnose bei Stress',
                    description: 'Stress abbauen und gelassener werden mit Hypnose in Bern',
                    url: 'https://bern-hypnose.ch/hypnosetherapie/stress/'
                }
            },
            {
                '@type': 'Offer',
                itemOffered: {
                    '@type': 'Service',
                    name: 'Hypnose bei Burnout',
                    description: 'Aus der Erschöpfung herausfinden mit Hypnose in Bern',
                    url: 'https://bern-hypnose.ch/hypnosetherapie/burnout/'
                }
            },
            {
                '@type': 'Offer',
                itemOffered: {
                    '@type': 'Service',
                    name: 'Hypnose bei Depression',
                    description: 'Wieder Lebensfreude finden mit Hypnose in Bern',
                    url: 'https://bern-hypnose.ch/hypnosetherapie/depression/'
                }
            },
            {
                '@type': 'Offer',
                itemOffered: {
                    '@type': 'Service',
                    name: 'Kinderhypnose',
                    description: 'Sanfte Hypnosetherapie für Kinder bei Ängsten und Blockaden'
                }
            },
            {
                '@type': 'Offer',
                itemOffered: {
                    '@type': 'Service',
                    name: 'Sporthypnose',
                    description: 'Mentales Training und Leistungssteigerung für Sportler durch Hypnose'
                }
            }
        ]
    }
};
---

<!-- MedicalBusiness Schema - Dynamically generated with latest reviews -->
<script type="application/ld+json" set:html={JSON.stringify(medicalBusinessSchema)} />

<!-- FAQ Schema - Dynamically generated from content collection -->
<script type="application/ld+json" set:html={JSON.stringify(faqSchemaData)} />

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Geführte Kurzhypnose App",
        "url": "https://bern-hypnose.ch/app/",
        "description": "Nimm dir einen ruhigen Moment Zeit, mach es dir bequem und lass dich von meiner App in einen Zustand tiefer Entspannung führen.",
        "applicationCategory": "LifestyleApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0.00",
            "priceCurrency": "CHF"
        },
        "author": {
            "@type": "Person",
            "name": "Janine Aerni"
        }
    }
</script>

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@type": "ListItem",
                "position": 1,
                "name": "Hypnosetherapie Bern",
                "item": "https://bern-hypnose.ch/"
            }
        ]
    }
</script>
