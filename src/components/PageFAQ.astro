---
import { getCollection } from 'astro:content';

export interface Props {
    /** The page path to filter FAQs for, e.g., '/hypnosetherapie/aengste-und-phobien/' */
    pagePath: string;
    /** Custom title for the FAQ section */
    title?: string;
    /** Include FAQ schema markup (only set true on ONE page per FAQ) */
    includeSchema?: boolean;
}

const { pagePath, title = 'Häufige Fragen', includeSchema = true } = Astro.props;

// Fetch FAQs for this specific page
const faqs = (await getCollection('faq')).filter((faq) => faq.data.showOnPages?.includes(pagePath)).sort((a, b) => a.data.order - b.data.order);

// Generate schema data if needed
const schemaData =
    includeSchema && faqs.length > 0
        ? {
              '@context': 'https://schema.org',
              '@type': 'FAQPage',
              mainEntity: faqs.map((faq) => ({
                  '@type': 'Question',
                  name: faq.data.title,
                  acceptedAnswer: {
                      '@type': 'Answer',
                      text: faq.data.shortAnswer || faq.data.teaser || faq.data.description || ''
                  }
              }))
          }
        : null;
---

{
    faqs.length > 0 && (
        <section class="prose sm:prose-lg mt-12">
            <h2>{title}</h2>

            {schemaData && <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />}

            <div class="not-prose border-gray-400 border-b">
                {faqs.map((faq) => (
                    <details class="group border-t border-gray-400">
                        <summary class="font-bold text-lg cursor-pointer text-main hover:text-red-700 px-1 py-5 list-none flex items-center justify-between">
                            <span>{faq.data.title}</span>
                            <span class="text-red-600 transform transition-transform group-open:rotate-180">▼</span>
                        </summary>
                        <div class="mt-3 mb-6 text-gray-900 prose px-1">
                            <p set:html={faq.data.shortAnswer} />
                            {faq.data.linkTo && (
                                <a href={faq.data.linkTo} class="text-red-700 hover:text-red-800 font-medium">
                                    → {faq.data.linkText || 'Mehr erfahren'}
                                </a>
                            )}
                        </div>
                    </details>
                ))}
            </div>
        </section>
    )
}
