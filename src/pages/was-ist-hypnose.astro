---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import ArrowLeft from '../icons/ArrowLeft.astro';
import { Image } from 'astro:assets';
import faqImage from '@assets/uploads/thinking.png';

// Simple function to convert Markdown to plain text
function markdownToPlainText(markdown: string) {
    if (!markdown) return '';
    return markdown
        .replace(/!\[.*?\]\(.*?\)/g, '') // Remove images
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Remove links but keep the link text
        .replace(/[#_*`~>+\-=|{}.!]/g, '') // Remove Markdown symbols
        .replace(/[\r\n]+/g, ' ') // Replace newlines with spaces
        .trim();
}

const backlink = {
    title: 'Home',
    url: '/'
};

// Fetch and sort the FAQs
const faqs = (await getCollection('faq')).sort((a, b) => {
    return a.data.order - b.data.order;
});

// For each FAQ, render its body content as HTML and extract plain text for schema
const renderedFaqs = await Promise.all(
    faqs.map(async (faq) => {
        const { Content } = await faq.render();
        const plainText = markdownToPlainText(faq.body); // Convert Markdown to plain text
        return { ...faq, Content, plainText };
    })
);

// Build the FAQPage schema data with plain text answers
// Only include FAQs that have actual answer text
const faqsWithAnswers = renderedFaqs.filter((faq) => {
    const answerText = faq.plainText || faq.data.description || faq.data.teaser || '';
    return answerText.trim().length > 0;
});

const faqSchemaData = {
    '@context': 'https://schema.org',
    '@type': 'FAQPage',
    name: 'Was ist Hypnose? Häufige Fragen',
    mainEntity: faqsWithAnswers.map((faq) => ({
        '@type': 'Question',
        name: faq.data.title,
        acceptedAnswer: {
            '@type': 'Answer',
            text: faq.plainText || faq.data.description || faq.data.teaser || faq.data.title // Fallback chain to ensure text is never empty
        }
    }))
};
---

<BaseLayout title="Was ist Hypnose und wie funktioniert Hypnosetherapie?" description="Alle häufig gestellten Fragen über Hypnose und Hypnosetherapie">
    <!-- Embedding FAQ Schema with JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(faqSchemaData)} />
    
    <article class="mb-16">
        <header class="mb-8 relative">
            {
                backlink && (
                    <a class="flex items-center absolute text-red-500 hover:text-red-700 -mt-8 text-sm font-bold" href={backlink.url}>
                        <ArrowLeft class="w-4 h-4 fill-current" />
                        <span>{backlink.title}</span>
                    </a>
                )
            }
            <h1 class="text-balance mb-8">Was ist Hypnose? Häufige Fragen</h1>
            <Image
                width={704}
                src={faqImage}
                class="w-full rounded-xl shadow-lg"
                alt="Was ist Hypnose"
                widths={[360, 520, 704]}
                sizes="(max-width: 768px) calc(100vw - 40px), 704px"
            />
            <p class="my-8 text-lg">
                Auf dieser Seite findest du Antworten auf häufig gestellte Fragen rund um Hypnose und Hypnosetherapie. Wenn du hier keine Antwort auf deine
                Frage entdeckst, zögere bitte nicht, mich direkt zu kontaktieren.
            </p>
        </header>

        <div class="max-w-none prose prose-dante sm:prose-lg">
            {
                renderedFaqs.map((faq) => {
                    return (
                        <a
                            href={`/was-ist-hypnose/${faq.slug}/`}
                            class="not-prose group block relative w-full rounded-xl relative z-10 hover:shadow-lg block grow mb-1 rounded-xl border border-gray-200 hover:border-red-300 hover:shadow-lg transition-all duration-200 no-underline"
                            data-order={faq.data.order}
                            aria-label={faq.data.linkText || `${faq.data.title} - Vollständige Antwort lesen`}
                        >
                            <div class="absolute z-0 top-0 right-0 bottom-0 left-0 rounded-xl transition-all duration-500 ease-in-out opacity-0 group-hover:opacity-25 group-hover:scale-[1.4] bg-yellow-300 blur-3xl pointer-events-none" />
                            <div class="py-12 px-6 rounded-xl relative z-10 hover:bg-[rgb(var(--color-bg-main)/0.5)]">
                                <h2 class="text-xl mt-0 leading-tight font-black sm:text-3xl text-gray-900 mb-3">{faq.data.title}</h2>
                                <p class="mb-0">{faq.data.teaser || faq.plainText.substring(0, 200) + '...'}</p>
                                <span class="text-red-700 font-semibold mt-2 inline-block">{faq.data.linkText || 'Vollständige Antwort lesen'} →</span>
                            </div>
                        </a>
                    );
                })
            }
        </div>
    </article>
</BaseLayout>
